<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icon-192.png" />
  <title>UZMAN Puantaj</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2f; --panel2:#111f3a; --card:#0e1a33;
      --text:#e8eefc; --muted:#9bb0d3; --line:rgba(255,255,255,.08);
      --blue:#2563eb; --blue2:#1d4ed8; --green:#22c55e; --amber:#f59e0b; --red:#ef4444;
      --shadow: 0 12px 35px rgba(0,0,0,.35);
      --r: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1000px 600px at 20% -10%, rgba(37,99,235,.25), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(34,197,94,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .app{min-height:100%; display:flex; flex-direction:column}
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.72));
      border-bottom:1px solid var(--line);
    }
    .bar{
      max-width:1200px; margin:0 auto; padding:14px 16px;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, rgba(37,99,235,1), rgba(29,78,216,1));
      display:grid; place-items:center; box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .logo:before{
      content:""; position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 55%);
      transform: rotate(25deg);
    }
    .logo span{font-weight:800; letter-spacing:.5px; position:relative}
    .brand h1{font-size:15px; margin:0; letter-spacing:.2px}
    .brand small{display:block; margin-top:2px; color:var(--muted); font-size:12px}
    .topActions{display:flex; gap:10px; align-items:center}
    .pill{
      padding:8px 10px; border:1px solid var(--line); background: rgba(255,255,255,.04);
      border-radius:999px; color:var(--muted); font-size:12px; display:flex; gap:8px; align-items:center;
    }
    .pill b{color:var(--text); font-weight:700}
    main{flex:1}
    .wrap{max-width:1200px; margin:0 auto; padding:18px 16px 28px}
    .grid{display:grid; gap:14px}
    @media (min-width: 980px){
      .grid.admin{grid-template-columns: 380px 1fr}
      .grid.person{grid-template-columns: 420px 1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .card .hd h2{margin:0; font-size:14px}
    .card .hd p{margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.35}
    .card .bd{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex:1 1 170px}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(9,14,25,.55);
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color: rgba(37,99,235,.6); box-shadow: 0 0 0 4px rgba(37,99,235,.12)}
    textarea{min-height:90px; resize:vertical}
    .btn{
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      font-weight:700;
      transition: .15s transform ease, .15s background ease, .15s border-color ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08)}
    .btn:active{transform: translateY(0)}
    .btn.primary{background: linear-gradient(135deg, var(--blue), var(--blue2)); border-color: rgba(37,99,235,.6)}
    .btn.primary:hover{background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(29,78,216,.95))}
    .btn.green{background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(16,185,129,.95)); border-color: rgba(34,197,94,.55)}
    .btn.red{background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(220,38,38,.95)); border-color: rgba(239,68,68,.55)}
    .btn.ghost{background: transparent}
    .btn.small{padding:9px 10px; border-radius:12px; font-size:12px}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .seg{
      display:flex; background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:999px; padding:4px;
      gap:4px;
    }
    .seg button{
      flex:1; border-radius:999px; border:0;
      background: transparent; color:var(--muted);
      padding:10px 10px; cursor:pointer; font-weight:800;
    }
    .seg button.on{background: rgba(37,99,235,.22); color:var(--text)}
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .kpi .box{
      flex:1 1 160px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .kpi .box .t{font-size:12px; color:var(--muted)}
    .kpi .box .v{margin-top:6px; font-size:18px; font-weight:900}
    .kpi .box .s{margin-top:4px; font-size:12px; color:var(--muted)}
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 10px; border-bottom:1px solid var(--line); font-size:12px; vertical-align:top}
    th{color:var(--muted); font-weight:800; text-align:left; background: rgba(255,255,255,.02)}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; font-size:11px;
      border:1px solid var(--line); background: rgba(255,255,255,.03); color:var(--muted);
      white-space:nowrap;
    }
    .tag.green{border-color: rgba(34,197,94,.35); color: rgba(167,243,208,.95); background: rgba(34,197,94,.08)}
    .tag.red{border-color: rgba(239,68,68,.35); color: rgba(254,202,202,.95); background: rgba(239,68,68,.08)}
    .tag.blue{border-color: rgba(37,99,235,.35); color: rgba(191,219,254,.95); background: rgba(37,99,235,.10)}
    .list{
      display:flex; flex-direction:column; gap:10px;
    }
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px;
      display:flex; justify-content:space-between; gap:10px;
      cursor:pointer;
      transition: .12s background ease, .12s transform ease;
    }
    .item:hover{background: rgba(255,255,255,.05); transform: translateY(-1px)}
    .item .name{font-weight:900}
    .item .sub{color:var(--muted); font-size:12px; margin-top:3px}
    .ico{font-family: "Segoe UI Symbol", "Apple Color Emoji", "Noto Color Emoji", sans-serif}
    .toast{
      position: fixed; left:50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(15,26,47,.92);
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 10px 12px;
      display:none; align-items:center; gap:10px;
      box-shadow: var(--shadow);
      z-index: 99;
      max-width: 92vw;
    }
    .toast.show{display:flex}
    .toast .msg{font-size:12px; color:var(--text)}
    .toast .x{border:0; background: transparent; color:var(--muted); cursor:pointer; font-size:16px; line-height:1}
    .muted{color:var(--muted)}
    .hr{height:1px; background: var(--line); margin:12px 0}
    .right{
      display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap;
    }
    .mono{font-family: var(--mono)}
    .foot{
      text-align:center; color:var(--muted); font-size:12px; padding:18px 10px;
    }
    .dangerBox{
      padding:12px; border-radius:16px;
      border:1px dashed rgba(239,68,68,.45);
      background: rgba(239,68,68,.06);
      color: rgba(254,202,202,.95);
      font-size:12px;
      line-height:1.35;
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="bar">
      <div class="brand">
        <div class="logo"><span>U</span></div>
        <div>
          <h1>UZMAN Puantaj</h1>
          <small id="subtitle">Puantaj + konum doƒürulama</small>
        </div>
      </div>
      <div class="topActions">
        <div class="pill" id="sessionPill" style="display:none;">
          <span class="ico">üë§</span>
          <span><b id="who"></b> ¬∑ <span id="role"></span></span>
        </div>
        <button class="btn small ghost" id="logoutBtn" style="display:none;">√áƒ±kƒ±≈ü</button>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap" id="viewLogin">
      <div class="card">
        <div class="hd">
          <div>
            <h2>Giri≈ü</h2>
            <p>Telefon + PIN ile giri≈ü. Konum izni verilmeyen cihazlarda ‚ÄúBa≈ülandƒ±‚Äù kaydƒ± olu≈üturulmaz.</p>
          </div>
          <span class="tag blue">PWA</span>
        </div>
        <div class="bd">
          <div class="seg" style="max-width:420px;">
            <button id="tabPersonel" class="on">Personel</button>
            <button id="tabAdmin">Admin</button>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="col">
              <label>Telefon (TR)</label>
              <input id="loginPhone" inputmode="tel" placeholder="+905xxxxxxxxx" />
            </div>
            <div class="col">
              <label>PIN</label>
              <input id="loginPin" inputmode="numeric" maxlength="8" placeholder="****" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="loginBtn">Giri≈ü yap</button>
            <button class="btn" id="installBtn" style="display:none;">Ana ekrana ekle</button>
          </div>

          <div class="hr"></div>
          <div class="dangerBox">
            <b>Not:</b> Bu s√ºr√ºm ‚Äúdemo + yerel kayƒ±t‚Äù mantƒ±ƒüƒ±yla √ßalƒ±≈üƒ±r (tarayƒ±cƒ± depolamasƒ±). Ger√ßek √ºretimde sunucu + veritabanƒ± gerekir.
          </div>
        </div>
      </div>
    </div>

    <div class="wrap" id="viewPersonel" style="display:none;">
      <div class="grid person">
        <div class="card">
          <div class="hd">
            <div>
              <h2>Mesai</h2>
              <p>2 buton: <b>Ba≈ülandƒ±</b> ve <b>Bitti</b>. Her iki i≈ülemde konum alƒ±nƒ±r. Konum izni yoksa i≈ülem yapƒ±lamaz.</p>
            </div>
            <span class="tag" id="pStateTag">Hazƒ±r</span>
          </div>
          <div class="bd">
            <div class="row">
              <div class="col">
                <label>Terminal</label>
                <select id="pTerminal"></select>
              </div>
              <div class="col">
                <label>Planlanan Sevk (opsiyonel)</label>
                <input id="pPlan" placeholder="√∂rn. 10:30 / Gemi / Ara√ß" />
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn green" id="btnStart">Ba≈ülandƒ±</button>
              <button class="btn red" id="btnEnd" disabled>Bitti</button>
            </div>

            <div class="hr"></div>
            <div class="kpi">
              <div class="box">
                <div class="t">Bug√ºn toplam</div>
                <div class="v" id="kToday">0:00</div>
                <div class="s muted">> 9 saatte 1 saat mola d√º≈üer</div>
              </div>
              <div class="box">
                <div class="t">Son kayƒ±t</div>
                <div class="v" id="kLast">‚Äî</div>
                <div class="s" id="kLastSub">‚Äî</div>
              </div>
            </div>

            <div class="hr"></div>
            <div class="muted" style="font-size:12px; line-height:1.4;">
              Konum doƒürulama: <span class="mono" id="pLocState">Hen√ºz istenmedi.</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>G√ºnl√ºk Mesai √áizelgesi</h2>
              <p>Geriye d√∂n√ºk kayƒ±tlar. Admin panelinde tarih aralƒ±ƒüƒ± + net s√ºre (mola dahil) g√∂r√ºl√ºr.</p>
            </div>
            <span class="tag blue" id="pCountTag">0 kayƒ±t</span>
          </div>
          <div class="bd">
            <div style="overflow:auto; border-radius:14px; border:1px solid var(--line);">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Ba≈ülangƒ±√ß</th>
                    <th>Biti≈ü</th>
                    <th>Br√ºt</th>
                    <th>Mola</th>
                    <th>Net</th>
                    <th>Terminal</th>
                    <th>Konum</th>
                  </tr>
                </thead>
                <tbody id="pRows"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="wrap" id="viewAdmin" style="display:none;">
      <div class="grid admin">
        <div class="card">
          <div class="hd">
            <div>
              <h2>Admin Panel</h2>
              <p>Personel/terminal/admin y√∂netimi + tarih aralƒ±ƒüƒ±nda puantaj ve konum kanƒ±tƒ±.</p>
            </div>
            <span class="tag blue">Y√∂netim</span>
          </div>
          <div class="bd">
            <div class="row">
              <button class="btn primary" id="btnAddPersonel">Personel ekle</button>
              <button class="btn" id="btnAddTerminal">Terminal ekle</button>
              <button class="btn" id="btnAdmins">Adminler</button>
              <button class="btn" id="btnAdminPin">PIN deƒüi≈ütir</button>
            </div>

            <div class="hr"></div>

            <label>Personel listesi</label>
            <div class="list" id="aList"></div>

            <div class="hr"></div>
            <div class="muted" style="font-size:12px;">
              ƒ∞pucu: Bir personeli se√ßince saƒü tarafta tarih aralƒ±ƒüƒ±na g√∂re mesailer + konum linkleri g√∂r√ºn√ºr.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2 id="aTitle">Se√ßim bekleniyor</h2>
              <p id="aSub">Soldan bir personel se√ßin.</p>
            </div>
            <span class="tag" id="aStatusTag">‚Äî</span>
          </div>
          <div class="bd">
            <div id="aEmpty" class="muted">Hen√ºz personel se√ßilmedi.</div>

            <div id="aPanel" style="display:none;">
              <div class="row">
                <div class="col">
                  <label>Ba≈ülangƒ±√ß tarihi</label>
                  <input id="rangeFrom" type="date" />
                </div>
                <div class="col">
                  <label>Biti≈ü tarihi</label>
                  <input id="rangeTo" type="date" />
                </div>
                <div class="col" style="min-width:190px;">
                  <label>&nbsp;</label>
                  <button class="btn primary" id="btnApplyRange">G√∂ster</button>
                </div>
              </div>

              <div class="hr"></div>

              <div class="kpi">
                <div class="box">
                  <div class="t">Toplam net</div>
                  <div class="v" id="aTotalNet">0:00</div>
                  <div class="s">Se√ßili aralƒ±k</div>
                </div>
                <div class="box">
                  <div class="t">Toplam mola</div>
                  <div class="v" id="aTotalBreak">0:00</div>
                  <div class="s">> 9 saatte 1 saat</div>
                </div>
                <div class="box">
                  <div class="t">Kayƒ±t adedi</div>
                  <div class="v" id="aCount">0</div>
                  <div class="s">Oturum</div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row" style="align-items:flex-end;">
                <div class="col">
                  <label>Manuel mesai ekle/d√ºzelt</label>
                  <div class="muted" style="font-size:12px; line-height:1.35;">
                    Sadece admin. ‚ÄúBa≈ülatmayƒ±/Bitmeyi unutan‚Äù personel i√ßin.
                  </div>
                </div>
                <div class="col" style="max-width:220px;">
                  <label>&nbsp;</label>
                  <button class="btn" id="btnManual">Manuel giri≈ü</button>
                </div>
              </div>

              <div class="hr"></div>

              <div style="overflow:auto; border-radius:14px; border:1px solid var(--line);">
                <table>
                  <thead>
                    <tr>
                      <th>Tarih</th>
                      <th>Ba≈ülangƒ±√ß</th>
                      <th>Biti≈ü</th>
                      <th>Br√ºt</th>
                      <th>Mola</th>
                      <th>Net</th>
                      <th>Terminal</th>
                      <th>Konum kanƒ±tƒ±</th>
                      <th>ƒ∞≈ülem</th>
                    </tr>
                  </thead>
                  <tbody id="aRows"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </main>

  <div class="foot">¬© UZMAN ¬∑ Puantaj</div>
</div>

<div class="toast" id="toast">
  <div class="msg" id="toastMsg">‚Äî</div>
  <button class="x" id="toastX">√ó</button>
</div>

<script>
/** =========================
 *  UZMAN Puantaj (Client-only demo)
 *  - LocalStorage "DB"
 *  - Location required on Start/End
 *  - Admin range view + break rule
 *  - Admin/personnel/admins/terminals management
 * ========================= */

const $ = (id)=>document.getElementById(id);
const fmt2 = (n)=>String(n).padStart(2,'0');

function toast(msg, ms=3500){
  const t=$('toast'); $('toastMsg').textContent=msg;
  t.classList.add('show');
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.classList.remove('show'), ms);
}
$('toastX').onclick=()=>$('toast').classList.remove('show');

function nowISO(){ return new Date().toISOString(); }
function todayKey(){
  const d=new Date();
  return d.getFullYear()+'-'+fmt2(d.getMonth()+1)+'-'+fmt2(d.getDate());
}
function isoToLocal(iso){
  const d=new Date(iso);
  return d.toLocaleString('tr-TR',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit',year:'numeric'});
}
function isoToTime(iso){
  const d=new Date(iso);
  return d.toLocaleString('tr-TR',{hour:'2-digit',minute:'2-digit'});
}
function isoToDate(iso){
  const d=new Date(iso);
  return d.toLocaleDateString('tr-TR');
}
function minutesBetween(aIso,bIso){
  const a=new Date(aIso).getTime();
  const b=new Date(bIso).getTime();
  if(!a||!b) return 0;
  return Math.max(0, Math.round((b-a)/60000));
}
function minsToHM(mins){
  const h=Math.floor(mins/60);
  const m=mins%60;
  return `${h}:${fmt2(m)}`;
}
function computeBreak(mins){
  // Rule: if a single work session gross > 9h => subtract 60 mins
  return mins>9*60 ? 60 : 0;
}
function googleMapsLink(lat,lng){
  return `https://www.google.com/maps?q=${lat},${lng}`;
}

const STORAGE_KEY = "uzman_puantaj_db_v1";

function loadDB(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(raw){
    try { return JSON.parse(raw); } catch(e){}
  }
  return null;
}
function saveDB(db){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
}

function normalizePhone(input){
  // Accept +90..., 05..., 5...
  let s = (input||"").trim();
  if(!s) return "";
  s = s.replace(/\s+/g,'');
  if(s.startsWith("00")) s = "+"+s.slice(2);
  if(s.startsWith("0")) s = "+90"+s.slice(1);
  if(s.startsWith("5")) s = "+90"+s;
  if(!s.startsWith("+")) s = "+"+s;
  // Keep digits + plus
  s = "+" + s.replace(/[^\d]/g,'');
  return s;
}

function last4(phone){
  const d = phone.replace(/[^\d]/g,'');
  return d.slice(-4);
}

/** --- Seed DB --- */
function seedDBIfNeeded(){
  let db=loadDB();
  if(db) return db;

  const owner1 = "+905368373204"; // ends 3204
  const owner2 = "+905432234916"; // ends 4916

  db = {
    version: 1,
    terminals: [
      { id: "t1", name: "1001Derince Terminali" },
      { id: "t2", name: "1003Marmara MDH" },
      { id: "t3", name: "1005Samsun Terminali" },
      { id: "t4", name: "1006Trabzon Terminali" },
      { id: "t5", name: "1014ƒ∞skenderun Terminali" }
    ],
    users: [
      // Owners (admin)
      { id: "u_owner1", role:"admin", phone: owner1, name:"Beytullah Uzman", pin:"4916", owner:true, createdAt: nowISO() },
      { id: "u_owner2", role:"admin", phone: owner2, name:"Beytullah Uzman", pin:"3204", owner:true, createdAt: nowISO() },

      // Sample personel
      { id: "u_p1", role:"personel", phone: "+905000000001", name:"√ñrnek Personel", pin:"0001", owner:false, createdAt: nowISO(), terminalId:"t1" }
    ],
    shifts: [
      // Each shift:
      // {id, userId, terminalId, plan, startAt, startLoc{lat,lng,acc}, endAt, endLoc{...}, manual, edited, editedAt, note}
    ]
  };
  saveDB(db);
  return db;
}

/** --- Session --- */
const SESSION_KEY = "uzman_puantaj_session";
function getSession(){
  const raw=localStorage.getItem(SESSION_KEY);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch(e){ return null; }
}
function setSession(sess){
  localStorage.setItem(SESSION_KEY, JSON.stringify(sess));
}
function clearSession(){ localStorage.removeItem(SESSION_KEY); }

let db = seedDBIfNeeded();
let session = getSession();

let loginMode = "personel"; // or admin
$('tabPersonel').onclick=()=>{loginMode="personel"; $('tabPersonel').classList.add('on'); $('tabAdmin').classList.remove('on');};
$('tabAdmin').onclick=()=>{loginMode="admin"; $('tabAdmin').classList.add('on'); $('tabPersonel').classList.remove('on');};

$('logoutBtn').onclick=()=>{
  clearSession(); session=null;
  showView('login');
  toast("√áƒ±kƒ±≈ü yapƒ±ldƒ±.");
};

/** --- PWA install prompt --- */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt=e;
  $('installBtn').style.display = "inline-flex";
});
$('installBtn').onclick=async()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt=null;
  $('installBtn').style.display="none";
};

async function ensureGeo(){
  if(!navigator.geolocation){
    toast("Bu cihaz konumu desteklemiyor.");
    return null;
  }
  return new Promise((resolve)=>{
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        resolve({
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          acc: Math.round(pos.coords.accuracy||0),
          at: nowISO()
        });
      },
      (err)=>{
        resolve({ error: true, code: err.code, message: err.message });
      },
      { enableHighAccuracy:true, timeout: 12000, maximumAge: 0 }
    );
  });
}

function showView(which){
  $('viewLogin').style.display = (which==='login') ? "" : "none";
  $('viewPersonel').style.display = (which==='personel') ? "" : "none";
  $('viewAdmin').style.display = (which==='admin') ? "" : "none";

  const pill = $('sessionPill');
  if(which==='login'){
    pill.style.display="none";
    $('logoutBtn').style.display="none";
    $('subtitle').textContent="Puantaj + konum doƒürulama";
  }else{
    pill.style.display="";
    $('logoutBtn').style.display="";
    $('who').textContent = session?.name || "";
    $('role').textContent = session?.role==="admin" ? "Admin" : "Personel";
    $('subtitle').textContent = session?.role==="admin" ? "Y√∂netim ekranƒ±" : "Personel ekranƒ±";
  }
}

function findUserByPhoneAndRole(phone, role){
  phone=normalizePhone(phone);
  return db.users.find(u=>u.phone===phone && u.role===role) || null;
}

function login(){
  const phone = normalizePhone($('loginPhone').value);
  const pin = ($('loginPin').value||"").trim();

  if(!phone || !pin){
    toast("Telefon ve PIN girin.");
    return;
  }

  const u = findUserByPhoneAndRole(phone, loginMode);
  if(!u){
    toast("Kullanƒ±cƒ± bulunamadƒ±.");
    return;
  }
  if(u.pin !== pin){
    toast("PIN hatalƒ±.");
    return;
  }

  session = { userId: u.id, role: u.role, name: u.name, phone: u.phone, owner: !!u.owner };
  setSession(session);

  $('loginPhone').value=""; $('loginPin').value="";
  if(session.role==="admin"){ initAdmin(); showView('admin'); }
  else { initPersonel(); showView('personel'); }
  toast("Giri≈ü ba≈üarƒ±lƒ±.");
}

$('loginBtn').onclick=login;
$('loginPin').addEventListener('keydown',(e)=>{ if(e.key==="Enter") login(); });

/** =========================
 *  PERSONEL
 * ========================= */
function activeShiftForUser(userId){
  // open shift: has startAt but no endAt
  return db.shifts.find(s=>s.userId===userId && s.startAt && !s.endAt) || null;
}

function initPersonel(){
  // terminals select
  const me = db.users.find(u=>u.id===session.userId);
  $('pTerminal').innerHTML = db.terminals.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
  if(me?.terminalId) $('pTerminal').value = me.terminalId;

  // state
  const open = activeShiftForUser(session.userId);
  if(open){
    $('btnStart').disabled=true;
    $('btnEnd').disabled=false;
    $('pStateTag').textContent="Mesai a√ßƒ±k";
    $('pStateTag').className="tag green";
  }else{
    $('btnStart').disabled=false;
    $('btnEnd').disabled=true;
    $('pStateTag').textContent="Hazƒ±r";
    $('pStateTag').className="tag";
  }
  renderPersonelTable();
  refreshPersonelKpis();
}

async function onStart(){
  const termId = $('pTerminal').value;
  const plan = ($('pPlan').value||"").trim();

  const loc = await ensureGeo();
  if(!loc || loc.error){
    $('pLocState').textContent = "Konum izni verilmedi / alƒ±namadƒ±.";
    toast("Konum izni olmadan mesai ba≈ülatƒ±lamaz.");
    return;
  }

  $('pLocState').textContent = `OK ¬∑ ${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)} (¬±${loc.acc}m)`;

  const id = "s_"+Math.random().toString(16).slice(2)+Date.now().toString(16);
  db.shifts.unshift({
    id,
    userId: session.userId,
    terminalId: termId,
    plan,
    startAt: nowISO(),
    startLoc: loc,
    endAt: null,
    endLoc: null,
    manual: false,
    edited: false,
    editedAt: null,
    note: ""
  });
  saveDB(db);

  initPersonel();
  toast("Mesai ba≈ülatƒ±ldƒ±.");
}

async function onEnd(){
  const open = activeShiftForUser(session.userId);
  if(!open){
    toast("A√ßƒ±k mesai bulunamadƒ±.");
    initPersonel();
    return;
  }
  const loc = await ensureGeo();
  if(!loc || loc.error){
    $('pLocState').textContent = "Konum izni verilmedi / alƒ±namadƒ±.";
    toast("Konum izni olmadan mesai bitirilemez.");
    return;
  }
  $('pLocState').textContent = `OK ¬∑ ${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)} (¬±${loc.acc}m)`;

  open.endAt = nowISO();
  open.endLoc = loc;
  open.edited = true; // any update marks
  open.editedAt = nowISO();

  saveDB(db);
  initPersonel();
  toast("Mesai bitirildi.");
}

$('btnStart').onclick=onStart;
$('btnEnd').onclick=onEnd;

function shiftComputed(s){
  const gross = (s.startAt && s.endAt) ? minutesBetween(s.startAt, s.endAt) : 0;
  const brk = (s.startAt && s.endAt) ? computeBreak(gross) : 0;
  const net = Math.max(0, gross - brk);
  return { gross, brk, net };
}

function renderPersonelTable(){
  const rows = db.shifts
    .filter(s=>s.userId===session.userId)
    .slice(0, 80);

  $('pCountTag').textContent = `${rows.length} kayƒ±t`;

  const tbody = $('pRows');
  tbody.innerHTML = "";

  if(rows.length===0){
    tbody.innerHTML = `<tr><td colspan="8" class="muted">Hen√ºz kayƒ±t yok.</td></tr>`;
    return;
  }

  for(const s of rows){
    const t = db.terminals.find(x=>x.id===s.terminalId)?.name || "‚Äî";
    const c = shiftComputed(s);
    const locTxt = (!s.startLoc) ? "‚Äî" : `<a href="${googleMapsLink(s.startLoc.lat,s.startLoc.lng)}" target="_blank">Ba≈ülangƒ±√ß</a>` +
      (s.endLoc ? ` ¬∑ <a href="${googleMapsLink(s.endLoc.lat,s.endLoc.lng)}" target="_blank">Biti≈ü</a>` : "");
    const badge = s.manual ? `<span class="tag">Manuel</span>` : (s.edited ? `<span class="tag blue">üëÅÔ∏è</span>` : "");
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${isoToDate(s.startAt)} ${badge}</td>
        <td>${isoToTime(s.startAt)}</td>
        <td>${s.endAt ? isoToTime(s.endAt) : '<span class="muted">‚Äî</span>'}</td>
        <td>${s.endAt ? minsToHM(c.gross) : '‚Äî'}</td>
        <td>${s.endAt ? minsToHM(c.brk) : '‚Äî'}</td>
        <td>${s.endAt ? minsToHM(c.net) : '‚Äî'}</td>
        <td>${t}</td>
        <td>${locTxt}</td>
      </tr>
    `);
  }
}

function refreshPersonelKpis(){
  const today = todayKey();
  const done = db.shifts.filter(s=>s.userId===session.userId && s.endAt);
  const todayDone = done.filter(s=> (new Date(s.startAt)).toISOString().slice(0,10) === today);
  let totalNet=0;
  for(const s of todayDone) totalNet += shiftComputed(s).net;
  $('kToday').textContent = minsToHM(totalNet);

  const last = db.shifts.find(s=>s.userId===session.userId && s.endAt) || null;
  if(!last){
    $('kLast').textContent="‚Äî";
    $('kLastSub').textContent="‚Äî";
    return;
  }
  const t = db.terminals.find(x=>x.id===last.terminalId)?.name || "‚Äî";
  const c = shiftComputed(last);
  $('kLast').textContent = minsToHM(c.net);
  $('kLastSub').textContent = `${isoToLocal(last.startAt)} ‚Üí ${isoToTime(last.endAt)} ¬∑ ${t}`;
}

/** =========================
 *  ADMIN
 * ========================= */
let selectedUserId=null;

function initAdmin(){
  renderAdminList();
  // default range: this week
  const d = new Date();
  const to = new Date(d);
  const from = new Date(d); from.setDate(from.getDate()-7);
  $('rangeTo').value = to.toISOString().slice(0,10);
  $('rangeFrom').value = from.toISOString().slice(0,10);

  $('aEmpty').style.display="";
  $('aPanel').style.display="none";
  selectedUserId=null;

  $('aTitle').textContent="Se√ßim bekleniyor";
  $('aSub').textContent="Soldan bir personel se√ßin.";
  $('aStatusTag').textContent="‚Äî";
  $('aStatusTag').className="tag";
}

function crown(u){ return u.owner ? " üëë" : ""; }

function renderAdminList(){
  const list = $('aList');
  list.innerHTML="";

  const people = db.users.filter(u=>u.role==="personel");
  if(people.length===0){
    list.innerHTML=`<div class="muted">Personel yok. ‚ÄúPersonel ekle‚Äù ile ekleyin.</div>`;
    return;
  }
  for(const u of people){
    const open = activeShiftForUser(u.id);
    const last = db.shifts.find(s=>s.userId===u.id)?.startAt;
    const lastText = last ? isoToLocal(last) : "Kayƒ±t yok";
    const tName = db.terminals.find(t=>t.id===u.terminalId)?.name || "Terminal yok";
    const flag = db.shifts.some(s=>s.userId===u.id && s.edited) ? " üëÅÔ∏è" : "";
    const badge = open ? `<span class="tag green">Aktif</span>` : `<span class="tag">Pasif</span>`;
    const item = document.createElement('div');
    item.className="item";
    item.innerHTML = `
      <div>
        <div class="name">${u.name}${flag}</div>
        <div class="sub">${u.phone} ¬∑ ${tName} ¬∑ ${lastText}</div>
      </div>
      <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
        ${badge}
        <span class="tag">${last4(u.phone)}</span>
      </div>
    `;
    item.onclick=()=>selectPersonel(u.id);
    list.appendChild(item);
  }
}

function selectPersonel(userId){
  selectedUserId=userId;
  const u = db.users.find(x=>x.id===userId);
  if(!u) return;
  $('aEmpty').style.display="none";
  $('aPanel').style.display="";
  $('aTitle').textContent = `${u.name}`;
  $('aSub').textContent = `${u.phone} ¬∑ PIN varsayƒ±lanƒ±: son 4 hane`;
  const open = activeShiftForUser(userId);
  $('aStatusTag').textContent = open ? "Aktif mesai" : "Mesai kapalƒ±";
  $('aStatusTag').className = open ? "tag green" : "tag";

  applyRange();
}

function betweenDates(iso, fromYmd, toYmd){
  const ymd = (new Date(iso)).toISOString().slice(0,10);
  return (ymd >= fromYmd && ymd <= toYmd);
}

function applyRange(){
  if(!selectedUserId) return;
  const from = $('rangeFrom').value;
  const to = $('rangeTo').value;
  if(!from || !to){ toast("Tarih aralƒ±ƒüƒ± se√ßin."); return; }

  const rows = db.shifts
    .filter(s=>s.userId===selectedUserId && s.startAt && betweenDates(s.startAt, from, to))
    .sort((a,b)=> (new Date(b.startAt)) - (new Date(a.startAt)));

  let totalNet=0, totalBreak=0;
  const tbody = $('aRows');
  tbody.innerHTML="";

  if(rows.length===0){
    tbody.innerHTML = `<tr><td colspan="9" class="muted">Bu aralƒ±kta kayƒ±t yok.</td></tr>`;
  }else{
    for(const s of rows){
      const t = db.terminals.find(x=>x.id===s.terminalId)?.name || "‚Äî";
      const c = shiftComputed(s);
      totalNet += c.net;
      totalBreak += c.brk;

      const startLoc = s.startLoc ? `Ba≈ülangƒ±√ß: <a href="${googleMapsLink(s.startLoc.lat,s.startLoc.lng)}" target="_blank">${s.startLoc.lat.toFixed(5)},${s.startLoc.lng.toFixed(5)}</a> (¬±${s.startLoc.acc}m)` : `<span class="muted">Ba≈ülangƒ±√ß konumu yok</span>`;
      const endLoc = s.endLoc ? `Biti≈ü: <a href="${googleMapsLink(s.endLoc.lat,s.endLoc.lng)}" target="_blank">${s.endLoc.lat.toFixed(5)},${s.endLoc.lng.toFixed(5)}</a> (¬±${s.endLoc.acc}m)` : `<span class="muted">Biti≈ü yok</span>`;
      const locBlock = `<div style="line-height:1.25;">${startLoc}<br/>${endLoc}</div>`;

      const mark = s.manual ? `<span class="tag">Manuel</span>` : (s.edited ? `<span class="tag blue">üëÅÔ∏è</span>` : "");
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${isoToDate(s.startAt)} ${mark}</td>
          <td>${isoToTime(s.startAt)}</td>
          <td>${s.endAt ? isoToTime(s.endAt) : '<span class="muted">‚Äî</span>'}</td>
          <td>${s.endAt ? minsToHM(c.gross) : '‚Äî'}</td>
          <td>${s.endAt ? minsToHM(c.brk) : '‚Äî'}</td>
          <td>${s.endAt ? minsToHM(c.net) : '‚Äî'}</td>
          <td>${t}</td>
          <td>${locBlock}</td>
          <td>
            <div class="right">
              <button class="btn small" onclick="editShift('${s.id}')">D√ºzenle</button>
              <button class="btn small" onclick="delShift('${s.id}')">Sil</button>
            </div>
          </td>
        </tr>
      `);
    }
  }

  $('aTotalNet').textContent = minsToHM(totalNet);
  $('aTotalBreak').textContent = minsToHM(totalBreak);
  $('aCount').textContent = String(rows.length);
}

$('btnApplyRange').onclick=applyRange;

window.delShift = function(shiftId){
  if(!selectedUserId) return;
  if(!confirm("Silmek istiyor musunuz?")) return;
  const idx = db.shifts.findIndex(s=>s.id===shiftId);
  if(idx>=0){
    db.shifts.splice(idx,1);
    saveDB(db);
    renderAdminList();
    applyRange();
    toast("Kayƒ±t silindi.");
  }
};

window.editShift = function(shiftId){
  const s = db.shifts.find(x=>x.id===shiftId);
  if(!s) return;
  const u = db.users.find(x=>x.id===s.userId);
  const term = db.terminals.find(x=>x.id===s.terminalId);
  const start = s.startAt ? s.startAt.slice(0,16) : "";
  const end = s.endAt ? s.endAt.slice(0,16) : "";

  const newStart = prompt(`Ba≈ülangƒ±√ß (YYYY-MM-DDTHH:MM) [${u?.name||''}]`, start);
  if(newStart===null) return;
  const newEnd = prompt(`Biti≈ü (YYYY-MM-DDTHH:MM)`, end);
  if(newEnd===null) return;

  // minimal validation
  if(!newStart || !/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(newStart)){
    toast("Ba≈ülangƒ±√ß formatƒ± hatalƒ±.");
    return;
  }
  if(newEnd && !/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(newEnd)){
    toast("Biti≈ü formatƒ± hatalƒ±.");
    return;
  }

  s.startAt = new Date(newStart).toISOString();
  s.endAt = newEnd ? new Date(newEnd).toISOString() : null;
  s.manual = true;
  s.edited = true;
  s.editedAt = nowISO();
  saveDB(db);
  renderAdminList();
  applyRange();
  toast("D√ºzenlendi.");
};

$('btnManual').onclick=()=>{
  if(!selectedUserId){ toast("√ñnce personel se√ßin."); return; }
  const u = db.users.find(x=>x.id===selectedUserId);
  const from = prompt("Tarih (YYYY-MM-DD) √∂rn: 2026-02-10", new Date().toISOString().slice(0,10));
  if(from===null) return;
  const st = prompt("Ba≈ülangƒ±√ß saat (HH:MM)", "08:00");
  if(st===null) return;
  const en = prompt("Biti≈ü saat (HH:MM) (bo≈ü bƒ±rak = a√ßƒ±k mesai)", "17:00");
  if(en===null) return;

  const termId = u.terminalId || db.terminals[0]?.id;
  const startAt = new Date(`${from}T${st}:00`).toISOString();
  const endAt = en ? new Date(`${from}T${en}:00`).toISOString() : null;

  const id = "s_"+Math.random().toString(16).slice(2)+Date.now().toString(16);
  db.shifts.unshift({
    id,
    userId: selectedUserId,
    terminalId: termId,
    plan: "",
    startAt,
    startLoc: null,
    endAt,
    endLoc: null,
    manual: true,
    edited: true,
    editedAt: nowISO(),
    note: "Manuel giri≈ü"
  });
  saveDB(db);
  renderAdminList();
  applyRange();
  toast("Manuel kayƒ±t eklendi.");
};

/** --- Admin: add personel --- */
$('btnAddPersonel').onclick=()=>{
  const name = prompt("Personel adƒ± soyadƒ±");
  if(!name) return;
  const phoneRaw = prompt("Telefon (+905xxxxxxxxx veya 05xx...)");
  if(!phoneRaw) return;
  const phone = normalizePhone(phoneRaw);
  if(!phone || phone.length < 12){ toast("Telefon formatƒ± hatalƒ±."); return; }
  if(db.users.some(u=>u.phone===phone)){ toast("Bu telefon zaten kayƒ±tlƒ±."); return; }

  const termId = $('promptTerminalId') || (db.terminals[0]?.id||"");
  const id = "u_"+Math.random().toString(16).slice(2)+Date.now().toString(16);

  db.users.push({
    id, role:"personel", phone, name,
    pin: last4(phone), owner:false, createdAt: nowISO(),
    terminalId: db.terminals[0]?.id || null
  });
  saveDB(db);
  renderAdminList();
  toast("Personel eklendi. Varsayƒ±lan PIN: son 4 hane.");
};

/** --- Admin: terminals --- */
$('btnAddTerminal').onclick=()=>{
  const name = prompt("Terminal adƒ± (√∂rn: 1001Derince Terminali)");
  if(!name) return;
  const id = "t_"+Math.random().toString(16).slice(2)+Date.now().toString(16);
  db.terminals.push({id, name});
  saveDB(db);
  renderAdminList();
  toast("Terminal eklendi.");
};

/** --- Admin: admin list --- */
$('btnAdmins').onclick=()=>{
  const admins = db.users.filter(u=>u.role==="admin");
  const lines = admins.map(a=>{
    const canDelete = (!a.owner);
    return `${a.name}${crown(a)} ¬∑ ${a.phone}` + (canDelete ? "" : " (silinemez)");
  }).join("\n");
  const act = prompt(
`Adminler:\n${lines}\n\nƒ∞≈ülem:\n1) Yeni admin ekle: "E"\n2) Admin sil: "S"\n(ƒ∞ptal: bo≈ü)`,
""
  );
  if(!act) return;
  if(act.toUpperCase()==="E"){
    const name = prompt("Yeni admin adƒ±");
    if(!name) return;
    const phoneRaw = prompt("Yeni admin telefon");
    if(!phoneRaw) return;
    const phone = normalizePhone(phoneRaw);
    if(db.users.some(u=>u.phone===phone)){ toast("Bu telefon zaten kayƒ±tlƒ±."); return; }
    const id = "u_"+Math.random().toString(16).slice(2)+Date.now().toString(16);
    db.users.push({ id, role:"admin", phone, name, pin:last4(phone), owner:false, createdAt: nowISO() });
    saveDB(db);
    toast("Yeni admin eklendi. Varsayƒ±lan PIN: son 4 hane.");
    return;
  }
  if(act.toUpperCase()==="S"){
    const targetRaw = prompt("Silinecek admin telefonu");
    if(!targetRaw) return;
    const target = normalizePhone(targetRaw);
    const t = db.users.find(u=>u.role==="admin" && u.phone===target);
    if(!t){ toast("Admin bulunamadƒ±."); return; }
    if(t.owner){
      toast("Owner admin silinemez.");
      return;
    }
    // Only owners can delete admins (non-owner). Enforce.
    if(!session.owner){
      toast("Sadece owner adminler admin silebilir.");
      return;
    }
    if(!confirm(`${t.name} (${t.phone}) silinsin mi?`)) return;
    db.users = db.users.filter(u=>u.id!==t.id);
    saveDB(db);
    toast("Admin silindi.");
  }
};

/** --- Admin: change PIN --- */
$('btnAdminPin').onclick=()=>{
  const me = db.users.find(u=>u.id===session.userId);
  if(!me) return;
  const oldPin = prompt("Mevcut PIN");
  if(oldPin===null) return;
  if(oldPin !== me.pin){
    toast("Mevcut PIN hatalƒ±.");
    return;
  }
  const newPin = prompt("Yeni PIN (4-8 hane)");
  if(!newPin) return;
  if(!/^\d{4,8}$/.test(newPin)){
    toast("PIN formatƒ± hatalƒ±.");
    return;
  }
  me.pin = newPin;
  saveDB(db);
  toast("PIN g√ºncellendi.");
};

/** --- Bootstrap on load --- */
(function boot(){
  // service worker
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(()=>{});
  }

  if(session){
    if(session.role==="admin"){ showView('admin'); initAdmin(); }
    else { showView('personel'); initPersonel(); }
  }else{
    showView('login');
  }

  // Reload DB if other tab changes
  window.addEventListener('storage', (e)=>{
    if(e.key===STORAGE_KEY){
      db = loadDB() || db;
      if(session?.role==="admin"){ renderAdminList(); applyRange(); }
      if(session?.role==="personel"){ initPersonel(); }
    }
  });
})();
</script>
</body>
</html>
