<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0a63ff" />
  <title>Uzman ‚Ä¢ Puantaj</title>
  <link rel="manifest" href="./manifest.json" />
  <style>
    :root{
      --bg:#070b16;
      --panel:#0c1226;
      --card:#0f1732;
      --text:#e9edff;
      --muted:#9aa6d6;
      --line:rgba(255,255,255,.10);
      --blue:#0a63ff;
      --blue2:#5aa2ff;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(1000px 700px at 15% -10%, rgba(10,99,255,.35), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(90,162,255,.18), transparent 60%),
        radial-gradient(1200px 900px at 50% 120%, rgba(10,99,255,.12), transparent 55%),
        var(--bg);
    }
    a{color:inherit}
    .wrap{min-height:100%; display:flex; flex-direction:column}
    .topbar{
      position:sticky; top:0; z-index:30;
      background: linear-gradient(180deg, rgba(7,11,22,.92), rgba(7,11,22,.55));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner{
      max-width:1100px; margin:0 auto;
      padding: 14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:38px; height:38px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--blue), var(--blue2));
      box-shadow: 0 10px 30px rgba(10,99,255,.28);
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.14);
      flex: 0 0 auto;
    }
    .logo svg{width:22px; height:22px}
    .brand h1{
      font-size:14px; letter-spacing:.5px; margin:0;
      display:flex; flex-direction:column; line-height:1.15;
    }
    .brand h1 span{font-size:12px; color:var(--muted); font-weight:600}
    .pill{
      padding:8px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      display:flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
    }
    .pill b{color:var(--text); font-weight:700}
    .main{
      flex:1;
      max-width:1100px;
      margin:0 auto;
      padding: 18px 16px 32px;
      width:100%;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:16px 16px 12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    .card-h h2{margin:0; font-size:14px; letter-spacing:.3px}
    .card-h p{margin:6px 0 0; color:var(--muted); font-size:12px}
    .card-b{padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .08s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
      user-select:none;
      text-decoration:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn:hover{background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.22)}
    .btn.primary{
      background: linear-gradient(135deg, var(--blue), var(--blue2));
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 14px 35px rgba(10,99,255,.25);
    }
    .btn.good{background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.30)}
    .btn.warn{background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.30)}
    .btn.bad{background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.30)}
    .btn[disabled]{opacity:.45; cursor:not-allowed}
    .btn svg{width:18px;height:18px}
    .input{
      width:100%;
      padding: 12px 12px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 14px;
      outline:none;
      color:var(--text);
      font-weight:700;
      letter-spacing:.2px;
    }
    .input::placeholder{color: rgba(154,166,214,.75); font-weight:600}
    .label{font-size:12px; color:var(--muted); margin: 0 0 6px 2px}
    .stack{display:grid; gap:12px}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width:520px){ .two{grid-template-columns:1fr} }
    .sep{height:1px; background: var(--line); margin: 12px 0}
    .tag{
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:12px; color: var(--muted);
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .tag .dot{width:8px;height:8px;border-radius:99px;background: var(--muted)}
    .dot.good{background: var(--good)}
    .dot.warn{background: var(--warn)}
    .dot.bad{background: var(--bad)}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:12px;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.12);
    }
    th,td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      text-align:left;
      vertical-align:top;
    }
    th{
      color: var(--muted);
      font-weight:800;
      font-size:11px;
      letter-spacing:.35px;
      background: rgba(255,255,255,.03);
      position:sticky; top:0;
    }
    tr:last-child td{border-bottom:0}
    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width:520px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .n{font-size:18px; font-weight:900}
    .kpi .t{font-size:11px; color:var(--muted); margin-top:4px}
    .muted{color:var(--muted)}
    .mini{font-size:12px}
    .mono{font-family: var(--mono)}
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(15,23,50,.92);
      border:1px solid rgba(255,255,255,.14);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      max-width: min(680px, calc(100% - 28px));
      display:none;
      z-index:100;
      font-size:12px;
      color: var(--text);
    }
    .toast.show{display:block}
    .right-actions{display:flex; gap:8px; align-items:center}
    .badge-crown{
      display:inline-flex; align-items:center; gap:6px;
      font-weight:900;
      color:#ffd36a;
    }
    .badge-crown svg{width:16px;height:16px}
    .smallhint{font-size:12px; color:var(--muted); line-height:1.35}
    .warnbox{
      border: 1px dashed rgba(245,158,11,.55);
      background: rgba(245,158,11,.08);
      padding: 10px 12px;
      border-radius: 14px;
      color: var(--text);
      font-size:12px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M7 16V8m10 8V8" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M5 8.5 12 5l7 3.5V19a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V8.5Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </div>
        <h1>
          Uzman Puantaj
          <span>Ba≈üla / Bitir + Konum Kaydƒ±</span>
        </h1>
      </div>
      <div class="right-actions">
        <div class="pill" id="whoPill">
          <span class="muted">Oturum:</span> <b>Yok</b>
        </div>
        <button class="btn" id="logoutBtn" style="display:none">
          <svg viewBox="0 0 24 24" fill="none"><path d="M10 7V6a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6a2 2 0 0 1-2-2v-1" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M15 12H4m0 0 3-3m-3 3 3 3" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          √áƒ±kƒ±≈ü
        </button>
      </div>
    </div>
  </div>

  <main class="main">
    <div class="grid">
      <!-- LEFT -->
      <section class="card" id="leftCard">
        <div class="card-h">
          <div>
            <h2 id="leftTitle">Giri≈ü</h2>
            <p id="leftDesc">Admin veya Personel olarak giri≈ü yap.</p>
          </div>
          <div class="row" id="roleSwitch">
            <button class="btn primary" data-role="ADMIN">Admin</button>
            <button class="btn" data-role="PERSONEL">Personel</button>
          </div>
        </div>
        <div class="card-b" id="leftBody"></div>
      </section>

      <!-- RIGHT -->
      <aside class="card" id="rightCard">
        <div class="card-h">
          <div>
            <h2>Durum</h2>
            <p>Yerel kayƒ±t (demo) + PWA</p>
          </div>
          <span class="tag"><span class="dot" id="swDot"></span><span id="swText">PWA hazƒ±r</span></span>
        </div>
        <div class="card-b" id="rightBody"></div>
      </aside>
    </div>
  </main>

  <div class="toast" id="toast"></div>
</div>

<script>
/** =========================
 *  UZMAN PUANTAJ ‚Äî SPA (LocalStorage)
 *  Root admin mantƒ±ƒüƒ± + √ßapraz PIN + admin ekle/sil + terminal ekle + manuel d√ºzeltme
 *  Not: Konum (Geolocation) HTTPS gerektirir (localhost hari√ß).
 * ========================= */

const ROOT_ADMINS = [
  { phone: "+905432234916", name: "Beytullah Uzman", pin: "3204", root: true, crown: true },
  { phone: "+905368373204", name: "Beytullah Uzman", pin: "4916", root: true, crown: true },
];

const STORAGE_KEY = "uzman_puantaj_v2_state";
const SESSION_KEY = "uzman_puantaj_v2_session";

const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));

function nowISO(){ return new Date().toISOString(); }
function fmtDT(iso){
  if(!iso) return "-";
  try{
    const d = new Date(iso);
    return d.toLocaleString("tr-TR", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  }catch(e){ return iso; }
}
function msToHM(ms){
  if(!ms || ms<0) return "0s";
  const s = Math.floor(ms/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const r = s%60;
  const parts=[];
  if(h) parts.push(h+"s");
  if(m) parts.push(m+"d");
  if(!h && !m) parts.push(r+"sn");
  return parts.join(" ");
}
function toast(msg, ms=2600){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  window.clearTimeout(toast._t);
  toast._t = window.setTimeout(()=>t.classList.remove("show"), ms);
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{ return JSON.parse(raw); }catch(e){}
  }
  // default seed
  const state = {
    admins: ROOT_ADMINS,
    terminals: [
      { id: uid(), name: "1001 Derince Terminali" },
      { id: uid(), name: "1012 Mersin Terminali" },
      { id: uid(), name: "1006 Trabzon Terminali" },
    ],
    personnel: [
      { id: uid(), name: "YUNUS √ñZKURT", phone: "+9053XXXXXXXXX", terminalId: null, active: true },
    ],
    shifts: [], // {id, personId, phone, name, terminalId, startAt, endAt, startLoc, endLoc, manualEdits:[]}
    audit: []   // actions
  };
  saveState(state);
  return state;
}
function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function loadSession(){
  const raw = sessionStorage.getItem(SESSION_KEY);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch(e){ return null; }
}
function saveSession(sess){
  if(!sess) sessionStorage.removeItem(SESSION_KEY);
  else sessionStorage.setItem(SESSION_KEY, JSON.stringify(sess));
}

function normalizeTR(phone){
  // Accept: 05xx..., 5xx..., +905xx..., 90...
  phone = (phone||"").trim();
  if(!phone) return "";
  phone = phone.replace(/\s/g,"");
  if(phone.startsWith("0") && phone.length===11) return "+9"+phone;
  if(phone.startsWith("5") && phone.length===10) return "+90"+phone;
  if(phone.startsWith("90") && phone.length===12) return "+"+phone;
  if(phone.startsWith("+90") && phone.length>=13) return phone;
  return phone;
}

function last4(phone){
  const digits = (phone||"").replace(/\D/g,"");
  return digits.slice(-4);
}

function isRootAdmin(phone){
  const p = normalizeTR(phone);
  return ROOT_ADMINS.some(a => a.phone === p);
}

function getAdminByPhone(state, phone){
  const p = normalizeTR(phone);
  return state.admins.find(a => normalizeTR(a.phone) === p) || null;
}

function upsertRootAdmins(state){
  // Ensure roots exist & pins fixed
  for(const r of ROOT_ADMINS){
    const existing = getAdminByPhone(state, r.phone);
    if(existing){
      existing.root = true;
      existing.crown = true;
      existing.name = r.name;
      existing.pin = r.pin; // enforce cross pin
    }else{
      state.admins.unshift({...r});
    }
  }
  // Remove duplicate root entries if any
  const seen = new Set();
  state.admins = state.admins.filter(a=>{
    const key = normalizeTR(a.phone);
    if(seen.has(key)) return false;
    seen.add(key);
    return true;
  });
}

function crownIcon(){
  return `
    <span class="badge-crown" title="Root Admin">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M4 9l4 4 4-7 4 7 4-4v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      </svg>
      üëë
    </span>`;
}

async function getGeo(){
  // Returns {ok, data?, error?}
  if(!navigator.geolocation){
    return { ok:false, error:"Cihaz konum desteƒüi yok." };
  }
  return await new Promise((resolve)=>{
    navigator.geolocation.getCurrentPosition(
      (pos)=> resolve({
        ok:true,
        data:{
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          acc: pos.coords.accuracy,
          ts: new Date(pos.timestamp).toISOString()
        }
      }),
      (err)=> resolve({ ok:false, error: err.message || "Konum alƒ±namadƒ±." }),
      { enableHighAccuracy:true, timeout: 12000, maximumAge: 0 }
    );
  });
}

function ensurePWAStatus(){
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").then(()=>{
      $("#swDot").className = "dot good";
      $("#swText").textContent = "PWA aktif";
    }).catch(()=>{
      $("#swDot").className = "dot warn";
      $("#swText").textContent = "PWA pasif";
    });
  }else{
    $("#swDot").className = "dot bad";
    $("#swText").textContent = "SW desteklenmiyor";
  }
}

function render(){
  const state = loadState();
  upsertRootAdmins(state);
  saveState(state);

  const sess = loadSession();
  const who = $("#whoPill");
  const logoutBtn = $("#logoutBtn");

  if(!sess){
    who.querySelector("b").textContent = "Yok";
    logoutBtn.style.display="none";
    renderLogin();
    renderRightInfo(state, null);
    return;
  }

  logoutBtn.style.display="inline-flex";
  logoutBtn.onclick = ()=>{ saveSession(null); toast("√áƒ±kƒ±≈ü yapƒ±ldƒ±."); render(); };

  if(sess.role === "ADMIN"){
    const admin = getAdminByPhone(state, sess.phone);
    who.querySelector("b").textContent = admin ? (`Admin ‚Ä¢ ${admin.name}${admin.root?" üëë":""}`) : "Admin";
    renderAdmin(state, admin);
    renderRightInfo(state, sess);
  }else{
    who.querySelector("b").textContent = `Personel ‚Ä¢ ${sess.name || sess.phone}`;
    renderPersonnel(state, sess);
    renderRightInfo(state, sess);
  }
}

function renderLogin(){
  $("#leftTitle").textContent = "Giri≈ü";
  $("#leftDesc").textContent = "Admin veya Personel olarak giri≈ü yap.";
  const left = $("#leftBody");
  const roleBtns = $$("#roleSwitch .btn");
  let selected = "ADMIN";
  roleBtns.forEach(b=>{
    b.onclick = ()=>{
      selected = b.dataset.role;
      roleBtns.forEach(x=>x.classList.remove("primary"));
      b.classList.add("primary");
      draw();
    };
  });

  function draw(){
    left.innerHTML = `
      <div class="stack">
        <div class="warnbox">
          <b>Not:</b> Konum kaydƒ± i√ßin uygulama <b>HTTPS</b> √ºzerinden a√ßƒ±lmalƒ±dƒ±r (localhost hari√ß).
        </div>
        <div>
          <div class="label">Telefon Numarasƒ± (TR)</div>
          <input class="input" id="loginPhone" placeholder="+9053xxxxxxxxx veya 05xxxxxxxxx" inputmode="tel" />
        </div>
        <div>
          <div class="label">PIN</div>
          <input class="input" id="loginPin" placeholder="4 haneli" inputmode="numeric" maxlength="4" />
          <div class="smallhint" style="margin-top:8px">
            Personel PIN: <b>telefonun son 4 hanesi</b>.<br/>
            Root admin PIN‚Äôleri: <b>√ßapraz</b> (4916 ‚Üî 3204).
          </div>
        </div>
        <div class="row">
          <button class="btn primary" id="loginBtn">
            <svg viewBox="0 0 24 24" fill="none"><path d="M10 17l5-5-5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 12h11" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
            Giri≈ü Yap (${selected === "ADMIN" ? "Admin" : "Personel"})
          </button>
        </div>
      </div>
    `;

    $("#loginBtn").onclick = ()=>{
      const state = loadState();
      upsertRootAdmins(state);
      saveState(state);

      const phone = normalizeTR($("#loginPhone").value);
      const pin = ($("#loginPin").value||"").trim();
      if(!phone || pin.length !== 4){ toast("Telefon ve 4 haneli PIN gir."); return; }

      if(selected === "ADMIN"){
        const admin = getAdminByPhone(state, phone);
        if(!admin){ toast("Bu numara admin listesinde yok."); return; }
        // enforce root pins
        if(admin.root){
          const root = ROOT_ADMINS.find(r => r.phone === normalizeTR(phone));
          if(root) admin.pin = root.pin;
        }
        if(pin !== String(admin.pin)){ toast("PIN hatalƒ±."); return; }
        saveSession({ role:"ADMIN", phone, name: admin.name });
        toast("Admin giri≈üi ba≈üarƒ±lƒ±.");
        render();
      } else {
        // Personnel: must exist in personnel list OR be allowed? We'll require exist.
        const p = state.personnel.find(x => normalizeTR(x.phone) === phone && x.active !== false);
        if(!p){ toast("Bu numara personel listesinde yok."); return; }
        const expected = last4(phone);
        if(pin !== expected){ toast("Personel PIN hatalƒ± (son 4 hane olmalƒ±)."); return; }
        saveSession({ role:"PERSONEL", phone, name: p.name, personId: p.id });
        toast("Personel giri≈üi ba≈üarƒ±lƒ±.");
        render();
      }
    };
  }
  draw();
}

function renderRightInfo(state, sess){
  const right = $("#rightBody");
  const totalPersonnel = state.personnel.filter(p=>p.active!==false).length;
  const totalTerminals = state.terminals.length;
  const openShifts = state.shifts.filter(s=>s.startAt && !s.endAt).length;

  right.innerHTML = `
    <div class="kpi">
      <div class="box">
        <div class="n">${totalPersonnel}</div>
        <div class="t">Aktif Personel</div>
      </div>
      <div class="box">
        <div class="n">${totalTerminals}</div>
        <div class="t">Terminal</div>
      </div>
      <div class="box">
        <div class="n">${openShifts}</div>
        <div class="t">A√ßƒ±k Mesai</div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="smallhint">
      <b>Demo √ßalƒ±≈üma mantƒ±ƒüƒ±:</b><br/>
      ‚Ä¢ Kayƒ±tlar cihazƒ±n tarayƒ±cƒ±sƒ±nda saklanƒ±r (LocalStorage).<br/>
      ‚Ä¢ Ger√ßek sunucu + veritabanƒ± eklendiƒüinde t√ºm cihazlar ortak g√∂r√ºr.<br/>
      ‚Ä¢ PWA olarak ekrandan ‚ÄúAna ekrana ekle‚Äù yapabilirsin.
    </div>
    <div class="sep"></div>
    <div class="smallhint">
      <b>Oturum:</b> ${sess ? `${sess.role} ‚Ä¢ ${sess.phone}` : "Yok"}
    </div>
  `;
}

function renderAdmin(state, admin){
  $("#leftTitle").textContent = "Admin Paneli";
  $("#leftDesc").textContent = "Personel, terminal ve mesai y√∂netimi.";

  const left = $("#leftBody");
  if(!admin){
    left.innerHTML = `<div class="warnbox">Admin bulunamadƒ±. √áƒ±kƒ±≈ü yapƒ±p tekrar giri≈ü yap.</div>`;
    return;
  }

  // Tabs
  left.innerHTML = `
    <div class="row" style="margin-bottom:12px">
      <button class="btn primary" data-tab="dashboard">Dashboard</button>
      <button class="btn" data-tab="personel">Personel</button>
      <button class="btn" data-tab="terminal">Terminal</button>
      <button class="btn" data-tab="admin">Adminler</button>
      <button class="btn" data-tab="mesai">Mesai</button>
    </div>
    <div id="tabBody"></div>
  `;
  const tabBtns = $$("#leftBody [data-tab]");
  let tab = "dashboard";

  tabBtns.forEach(b=>{
    b.onclick = ()=>{
      tab = b.dataset.tab;
      tabBtns.forEach(x=>x.classList.remove("primary"));
      b.classList.add("primary");
      draw();
    };
  });

  function draw(){
    const s = loadState(); upsertRootAdmins(s); saveState(s);
    const body = $("#tabBody");

    if(tab === "dashboard"){
      const today = new Date();
      const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
      const dayShifts = s.shifts.filter(x => {
        const t = new Date(x.startAt || x.endAt || 0).getTime();
        return t >= startOfDay;
      });

      body.innerHTML = `
        <div class="stack">
          <div class="two">
            <div class="card" style="box-shadow:none">
              <div class="card-h">
                <div>
                  <h2>Bug√ºn</h2>
                  <p>Ba≈ülayan / Biten / A√ßƒ±k</p>
                </div>
              </div>
              <div class="card-b">
                <div class="kpi" style="grid-template-columns:1fr 1fr 1fr">
                  <div class="box"><div class="n">${dayShifts.filter(x=>x.startAt).length}</div><div class="t">Ba≈ülayan</div></div>
                  <div class="box"><div class="n">${dayShifts.filter(x=>x.endAt).length}</div><div class="t">Biten</div></div>
                  <div class="box"><div class="n">${dayShifts.filter(x=>x.startAt && !x.endAt).length}</div><div class="t">A√ßƒ±k</div></div>
                </div>
              </div>
            </div>

            <div class="card" style="box-shadow:none">
              <div class="card-h">
                <div>
                  <h2>Konum</h2>
                  <p>Ba≈üla/Bitir konum kaydƒ±</p>
                </div>
              </div>
              <div class="card-b">
                <div class="smallhint">
                  Konum yetkisi reddedilirse kayƒ±t ‚Äúkonumsuz‚Äù i≈üaretlenir.<br/>
                  Sunucuya aktarƒ±m i√ßin bir sonraki a≈üamada API ekleriz.
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="card-h">
              <div>
                <h2>Son Kayƒ±tlar</h2>
                <p>En son 10 mesai</p>
              </div>
            </div>
            <div class="card-b">
              ${renderShiftTable(s, s.shifts.slice().sort((a,b)=> (b.startAt||"").localeCompare(a.startAt||"")).slice(0,10), true)}
            </div>
          </div>
        </div>
      `;
      return;
    }

    if(tab === "terminal"){
      body.innerHTML = `
        <div class="stack">
          <div class="two">
            <div>
              <div class="label">Yeni Terminal Adƒ±</div>
              <input class="input" id="newTerminalName" placeholder="√ñrn: 1012 Mersin Terminali" />
            </div>
            <div style="align-self:end">
              <button class="btn primary" id="addTerminalBtn">
                <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
                Terminal Ekle
              </button>
            </div>
          </div>
          <div class="sep"></div>
          ${renderTerminalList(s)}
        </div>
      `;
      $("#addTerminalBtn").onclick = ()=>{
        const name = ($("#newTerminalName").value||"").trim();
        if(!name){ toast("Terminal adƒ± gir."); return; }
        s.terminals.unshift({ id: uid(), name });
        s.audit.unshift({ at: nowISO(), by: admin.phone, action:"terminal_add", data:{name} });
        saveState(s);
        toast("Terminal eklendi.");
        draw();
      };
      return;
    }

    if(tab === "personel"){
      body.innerHTML = `
        <div class="stack">
          <div class="two">
            <div>
              <div class="label">Personel Ad Soyad</div>
              <input class="input" id="pName" placeholder="√ñrn: RAMAZAN ANT" />
            </div>
            <div>
              <div class="label">Telefon</div>
              <input class="input" id="pPhone" placeholder="+9053xxxxxxxxx" inputmode="tel" />
            </div>
            <div>
              <div class="label">Terminal</div>
              <select class="input" id="pTerminal">
                <option value="">Se√ßiniz</option>
                ${s.terminals.map(t=>`<option value="${t.id}">${escapeHtml(t.name)}</option>`).join("")}
              </select>
            </div>
            <div style="align-self:end">
              <button class="btn primary" id="addPersonBtn">
                <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
                Personel Ekle
              </button>
            </div>
          </div>

          <div class="sep"></div>
          ${renderPersonnelList(s)}
        </div>
      `;

      $("#addPersonBtn").onclick = ()=>{
        const name = ($("#pName").value||"").trim();
        const phone = normalizeTR($("#pPhone").value);
        const terminalId = $("#pTerminal").value || null;
        if(!name || !phone){ toast("Ad ve telefon gir."); return; }
        if(s.personnel.some(x=>normalizeTR(x.phone)===phone)){ toast("Bu telefon zaten kayƒ±tlƒ±."); return; }
        s.personnel.unshift({ id: uid(), name, phone, terminalId, active:true });
        s.audit.unshift({ at: nowISO(), by: admin.phone, action:"person_add", data:{name, phone, terminalId} });
        saveState(s);
        toast("Personel eklendi.");
        draw();
      };

      // handlers for toggle active
      $$("#tabBody [data-person-toggle]").forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.personToggle;
          const p = s.personnel.find(x=>x.id===id);
          if(!p) return;
          p.active = p.active === false ? true : false;
          s.audit.unshift({ at: nowISO(), by: admin.phone, action:"person_toggle", data:{id, active:p.active} });
          saveState(s);
          toast(p.active? "Aktif edildi." : "Pasif edildi.");
          draw();
        };
      });

      // handler for terminal change
      $$("#tabBody [data-person-terminal]").forEach(sel=>{
        sel.onchange = ()=>{
          const id = sel.dataset.personTerminal;
          const p = s.personnel.find(x=>x.id===id);
          if(!p) return;
          p.terminalId = sel.value || null;
          s.audit.unshift({ at: nowISO(), by: admin.phone, action:"person_terminal", data:{id, terminalId:p.terminalId} });
          saveState(s);
          toast("Terminal g√ºncellendi.");
        };
      });

      return;
    }

    if(tab === "admin"){
      // root logic: root admins can add/remove others; others can‚Äôt delete roots.
      body.innerHTML = `
        <div class="stack">
          <div class="warnbox">
            <b>Root Admin</b> (üëë) silinemez. Root PIN‚Äôleri sabittir (√ßapraz).<br/>
            Diƒüer adminler varsayƒ±lan PIN: <b>0000</b> (isteƒüe g√∂re deƒüi≈ütirilebilir).
          </div>

          <div class="two">
            <div>
              <div class="label">Yeni Admin Telefon</div>
              <input class="input" id="aPhone" placeholder="+9053xxxxxxxxx" inputmode="tel"/>
            </div>
            <div>
              <div class="label">Yeni Admin Adƒ±</div>
              <input class="input" id="aName" placeholder="√ñrn: Operasyon Sorumlusu"/>
            </div>
            <div style="align-self:end">
              <button class="btn primary" id="addAdminBtn">
                <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
                Admin Ekle
              </button>
            </div>
            <div style="align-self:end">
              <button class="btn" id="changeMyPinBtn">
                <svg viewBox="0 0 24 24" fill="none"><path d="M12 15v2m-6-8V7a6 6 0 0 1 12 0v2" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M7 9h10a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2Z" stroke="white" stroke-width="2"/></svg>
                PIN Deƒüi≈ütir (Ben)
              </button>
            </div>
          </div>

          <div class="sep"></div>
          ${renderAdminList(s)}
        </div>
      `;

      $("#addAdminBtn").onclick = ()=>{
        const phone = normalizeTR($("#aPhone").value);
        const name = ($("#aName").value||"").trim();
        if(!phone || !name){ toast("Telefon ve ad gir."); return; }
        if(getAdminByPhone(s, phone)){ toast("Bu numara zaten admin."); return; }
        s.admins.push({ phone, name, pin:"0000", root:false, crown:false });
        s.audit.unshift({ at: nowISO(), by: admin.phone, action:"admin_add", data:{phone, name} });
        saveState(s);
        toast("Admin eklendi.");
        draw();
      };

      $("#changeMyPinBtn").onclick = ()=>{
        if(admin.root){
          toast("Root admin PIN‚Äôi sabittir (√ßapraz).");
          return;
        }
        const newPin = prompt("Yeni PIN (4 hane):");
        if(!newPin) return;
        if(!/^\d{4}$/.test(newPin)){ toast("PIN 4 haneli olmalƒ±."); return; }
        admin.pin = newPin;
        const me = getAdminByPhone(s, admin.phone);
        if(me) me.pin = newPin;
        s.audit.unshift({ at: nowISO(), by: admin.phone, action:"admin_pin_change", data:{phone:admin.phone} });
        saveState(s);
        toast("PIN g√ºncellendi.");
        draw();
      };

      $$("#tabBody [data-admin-delete]").forEach(btn=>{
        btn.onclick = ()=>{
          const phone = btn.dataset.adminDelete;
          const target = getAdminByPhone(s, phone);
          if(!target) return;
          if(target.root){ toast("Root admin silinemez."); return; }
          if(!confirm("Bu admin silinsin mi?")) return;
          s.admins = s.admins.filter(a=>normalizeTR(a.phone)!==normalizeTR(phone));
          s.audit.unshift({ at: nowISO(), by: admin.phone, action:"admin_delete", data:{phone} });
          saveState(s);
          toast("Admin silindi.");
          draw();
        };
      });

      $$("#tabBody [data-admin-pin]").forEach(btn=>{
        btn.onclick = ()=>{
          const phone = btn.dataset.adminPin;
          const target = getAdminByPhone(s, phone);
          if(!target) return;
          if(target.root){ toast("Root PIN sabittir."); return; }
          const p = prompt("Yeni PIN (4 hane):", String(target.pin||"0000"));
          if(!p) return;
          if(!/^\d{4}$/.test(p)){ toast("PIN 4 haneli olmalƒ±."); return; }
          target.pin = p;
          s.audit.unshift({ at: nowISO(), by: admin.phone, action:"admin_pin_set", data:{phone} });
          saveState(s);
          toast("PIN g√ºncellendi.");
          draw();
        };
      });

      return;
    }

    if(tab === "mesai"){
      // filter + manual edit
      const people = s.personnel.filter(p=>p.active!==false);
      body.innerHTML = `
        <div class="stack">
          <div class="two">
            <div>
              <div class="label">Personel Se√ß</div>
              <select class="input" id="mPerson">
                <option value="">T√ºm√º</option>
                ${people.map(p=>`<option value="${p.id}">${escapeHtml(p.name)} ‚Ä¢ ${escapeHtml(p.phone)}</option>`).join("")}
              </select>
            </div>
            <div>
              <div class="label">Sadece a√ßƒ±k mesailer</div>
              <select class="input" id="mOpen">
                <option value="0">Hayƒ±r</option>
                <option value="1">Evet</option>
              </select>
            </div>
          </div>

          <div class="sep"></div>
          <div id="mTable"></div>

          <div class="sep"></div>
          <div class="warnbox">
            <b>Manuel d√ºzeltme</b> sadece admin yapabilir. Personel unutursa ba≈ülangƒ±√ß/biti≈ü saatini buradan ekleyebilirsin.
          </div>

          <div class="two">
            <div>
              <div class="label">Mesai ID</div>
              <input class="input" id="fixShiftId" placeholder="Tablodan kopyala" />
            </div>
            <div>
              <div class="label">Yeni Ba≈ülangƒ±√ß (YYYY-MM-DD HH:MM)</div>
              <input class="input" id="fixStart" placeholder="2026-02-08 08:00" />
            </div>
            <div>
              <div class="label">Yeni Biti≈ü (YYYY-MM-DD HH:MM)</div>
              <input class="input" id="fixEnd" placeholder="2026-02-08 17:30" />
            </div>
            <div style="align-self:end">
              <button class="btn primary" id="applyFixBtn">
                <svg viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Uygula
              </button>
            </div>
          </div>
        </div>
      `;

      function parseLocalDT(str){
        str = (str||"").trim();
        if(!str) return null;
        const m = str.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/);
        if(!m) return null;
        const [_,Y,M,D,h,mi] = m;
        const d = new Date(Number(Y), Number(M)-1, Number(D), Number(h), Number(mi), 0, 0);
        return d.toISOString();
      }

      function drawTable(){
        const personId = $("#mPerson").value || "";
        const onlyOpen = $("#mOpen").value === "1";
        let rows = s.shifts.slice().sort((a,b)=>(b.startAt||"").localeCompare(a.startAt||""));
        if(personId) rows = rows.filter(x=>x.personId===personId);
        if(onlyOpen) rows = rows.filter(x=>x.startAt && !x.endAt);
        $("#mTable").innerHTML = renderShiftTable(s, rows, false);
      }

      $("#mPerson").onchange = drawTable;
      $("#mOpen").onchange = drawTable;
      drawTable();

      $("#applyFixBtn").onclick = ()=>{
        const id = ($("#fixShiftId").value||"").trim();
        const start = parseLocalDT($("#fixStart").value);
        const end = parseLocalDT($("#fixEnd").value);

        const sh = s.shifts.find(x=>x.id===id);
        if(!sh){ toast("Mesai ID bulunamadƒ±."); return; }
        if(start) sh.startAt = start;
        if(end) sh.endAt = end;

        sh.manualEdits = sh.manualEdits || [];
        sh.manualEdits.unshift({
          at: nowISO(),
          by: admin.phone,
          start: start || null,
          end: end || null
        });
        s.audit.unshift({ at: nowISO(), by: admin.phone, action:"shift_manual_edit", data:{id} });
        saveState(s);
        toast("Manuel d√ºzeltme uygulandƒ±.");
        drawTable();
      };

      return;
    }
  }

  draw();
}

function renderShiftTable(state, shifts, showCopyId){
  if(!shifts.length){
    return `<div class="smallhint muted">Kayƒ±t yok.</div>`;
  }
  return `
    <div style="overflow:auto; border-radius:16px">
      <table>
        <thead>
          <tr>
            <th>Personel</th>
            <th>Terminal</th>
            <th>Ba≈ülangƒ±√ß</th>
            <th>Biti≈ü</th>
            <th>S√ºre</th>
            <th>Konum</th>
            ${showCopyId ? "<th>Mesai ID</th>":""}
          </tr>
        </thead>
        <tbody>
          ${shifts.map(s=>{
            const p = state.personnel.find(x=>x.id===s.personId) || {name:s.name||"-", phone:s.phone||"-"};
            const t = state.terminals.find(x=>x.id===s.terminalId);
            const dur = (s.startAt && s.endAt) ? msToHM(new Date(s.endAt)-new Date(s.startAt)) : (s.startAt && !s.endAt ? "A√ßƒ±k" : "-");
            const hasLoc = (s.startLoc || s.endLoc) ? "Var" : "Yok";
            return `
              <tr>
                <td><b>${escapeHtml(p.name||"-")}</b><div class="muted mini mono">${escapeHtml(p.phone||"-")}</div></td>
                <td>${escapeHtml(t ? t.name : "-")}</td>
                <td>${fmtDT(s.startAt)}</td>
                <td>${fmtDT(s.endAt)}</td>
                <td>${dur}</td>
                <td>${hasLoc}</td>
                ${showCopyId ? `<td class="mono">${s.id}</td>`:""}
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    </div>
  `;
}

function renderTerminalList(state){
  return `
    <div style="overflow:auto; border-radius:16px">
      <table>
        <thead><tr><th>Terminal</th><th>ID</th></tr></thead>
        <tbody>
          ${state.terminals.map(t=>`
            <tr>
              <td><b>${escapeHtml(t.name)}</b></td>
              <td class="mono">${t.id.slice(0,10)}‚Ä¶</td>
            </tr>`).join("")}
        </tbody>
      </table>
    </div>
  `;
}

function renderPersonnelList(state){
  const rows = state.personnel.slice().sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  return `
    <div style="overflow:auto; border-radius:16px">
      <table>
        <thead>
          <tr>
            <th>Personel</th>
            <th>Telefon</th>
            <th>Terminal</th>
            <th>Durum</th>
            <th>ƒ∞≈ülem</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(p=>{
            const t = state.terminals.find(x=>x.id===p.terminalId);
            const active = p.active !== false;
            return `
              <tr>
                <td><b>${escapeHtml(p.name)}</b></td>
                <td class="mono">${escapeHtml(p.phone||"-")}</td>
                <td>
                  <select class="input" data-person-terminal="${p.id}" style="padding:8px 10px">
                    <option value="">Se√ßiniz</option>
                    ${state.terminals.map(tt=>`<option value="${tt.id}" ${tt.id===p.terminalId?"selected":""}>${escapeHtml(tt.name)}</option>`).join("")}
                  </select>
                </td>
                <td>${active ? `<span class="tag"><span class="dot good"></span>Aktif</span>` : `<span class="tag"><span class="dot bad"></span>Pasif</span>`}</td>
                <td>
                  <button class="btn ${active?"warn":"good"}" data-person-toggle="${p.id}" style="padding:8px 10px">
                    ${active ? "Pasif Yap" : "Aktif Et"}
                  </button>
                </td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    </div>
  `;
}

function renderAdminList(state){
  const rows = state.admins.slice().sort((a,b)=> (b.root===true)-(a.root===true) || (a.name||"").localeCompare(b.name||""));
  return `
    <div style="overflow:auto; border-radius:16px">
      <table>
        <thead>
          <tr>
            <th>Admin</th>
            <th>Telefon</th>
            <th>Tip</th>
            <th>PIN</th>
            <th>ƒ∞≈ülem</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(a=>{
            const isRoot = a.root === true || isRootAdmin(a.phone);
            const pin = isRoot ? ROOT_ADMINS.find(r=>r.phone===normalizeTR(a.phone))?.pin : (a.pin || "0000");
            return `
              <tr>
                <td><b>${escapeHtml(a.name||"-")}</b> ${isRoot ? crownIcon() : ""}</td>
                <td class="mono">${escapeHtml(normalizeTR(a.phone))}</td>
                <td>${isRoot ? `<span class="tag"><span class="dot good"></span>Root</span>` : `<span class="tag"><span class="dot"></span>Admin</span>`}</td>
                <td class="mono">${escapeHtml(String(pin))}</td>
                <td class="row" style="gap:8px">
                  <button class="btn" data-admin-pin="${escapeHtml(normalizeTR(a.phone))}" style="padding:8px 10px">PIN</button>
                  ${isRoot ? "" : `<button class="btn bad" data-admin-delete="${escapeHtml(normalizeTR(a.phone))}" style="padding:8px 10px">Sil</button>`}
                </td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    </div>
  `;
}

function renderPersonnel(state, sess){
  $("#leftTitle").textContent = "Personel";
  $("#leftDesc").textContent = "Mesai ba≈ülat / bitir ve ge√ßmi≈üini g√∂r.";

  const left = $("#leftBody");
  const me = state.personnel.find(p=>p.id===sess.personId) || state.personnel.find(p=>normalizeTR(p.phone)===normalizeTR(sess.phone));
  if(!me){
    left.innerHTML = `<div class="warnbox">Personel kaydƒ± bulunamadƒ±. Admin‚Äôden numaranƒ± eklemesini iste.</div>`;
    return;
  }

  const term = state.terminals.find(t=>t.id===me.terminalId);
  const open = state.shifts.find(s=>s.personId===me.id && s.startAt && !s.endAt);

  const myShifts = state.shifts
    .filter(s=>s.personId===me.id)
    .slice()
    .sort((a,b)=>(b.startAt||"").localeCompare(a.startAt||""))
    .slice(0,25);

  left.innerHTML = `
    <div class="stack">
      <div class="two">
        <div>
          <div class="label">Profil</div>
          <div class="tag"><span class="dot good"></span><b>${escapeHtml(me.name)}</b> <span class="muted">‚Ä¢</span> <span class="mono">${escapeHtml(normalizeTR(me.phone))}</span></div>
          <div class="smallhint" style="margin-top:10px">
            Terminal: <b>${escapeHtml(term ? term.name : "Se√ßilmemi≈ü")}</b>
          </div>
        </div>
        <div>
          <div class="label">Durum</div>
          ${open ? `<div class="tag"><span class="dot warn"></span>Mesai A√ßƒ±k ‚Ä¢ ${fmtDT(open.startAt)}</div>` : `<div class="tag"><span class="dot good"></span>Kapalƒ±</div>`}
          <div class="smallhint" style="margin-top:10px">
            Ba≈üla/Bitir‚Äôe bastƒ±ƒüƒ±nda konum izni istenir ve kayƒ±t altƒ±na alƒ±nƒ±r.
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <button class="btn good" id="startBtn" ${open ? "disabled":""}>
          <svg viewBox="0 0 24 24" fill="none"><path d="M8 5v14l11-7L8 5Z" stroke="white" stroke-width="2" stroke-linejoin="round"/></svg>
          Ba≈ülandƒ±
        </button>
        <button class="btn bad" id="endBtn" ${open ? "":"disabled"}>
          <svg viewBox="0 0 24 24" fill="none"><path d="M6 6h12v12H6z" stroke="white" stroke-width="2"/></svg>
          Bitti
        </button>
      </div>

      <div class="sep"></div>

      <div class="card" style="box-shadow:none">
        <div class="card-h">
          <div>
            <h2>Mesai Ge√ßmi≈üi</h2>
            <p>Son 25 kayƒ±t</p>
          </div>
        </div>
        <div class="card-b">
          ${renderShiftTable(state, myShifts, false)}
        </div>
      </div>
    </div>
  `;

  $("#startBtn").onclick = async ()=>{
    const s = loadState(); upsertRootAdmins(s);
    const me2 = s.personnel.find(p=>p.id===me.id);
    if(!me2){ toast("Personel bulunamadƒ±."); return; }
    if(s.shifts.some(x=>x.personId===me2.id && x.startAt && !x.endAt)){ toast("Zaten a√ßƒ±k mesai var."); return; }

    toast("Konum alƒ±nƒ±yor...");
    const geo = await getGeo();
    const startLoc = geo.ok ? geo.data : { error: geo.error, ts: nowISO() };

    const shift = {
      id: uid(),
      personId: me2.id,
      phone: normalizeTR(me2.phone),
      name: me2.name,
      terminalId: me2.terminalId || null,
      startAt: nowISO(),
      endAt: null,
      startLoc,
      endLoc: null,
      manualEdits: []
    };
    s.shifts.unshift(shift);
    s.audit.unshift({ at: nowISO(), by: me2.phone, action:"shift_start", data:{id:shift.id, geo_ok: geo.ok} });
    saveState(s);

    toast(geo.ok ? "Mesai ba≈üladƒ±. Konum kaydedildi." : "Mesai ba≈üladƒ±. Konum alƒ±namadƒ± (izin/red).");
    render();
  };

  $("#endBtn").onclick = async ()=>{
    const s = loadState(); upsertRootAdmins(s);
    const open2 = s.shifts.find(x=>x.personId===me.id && x.startAt && !x.endAt);
    if(!open2){ toast("A√ßƒ±k mesai yok."); return; }

    toast("Konum alƒ±nƒ±yor...");
    const geo = await getGeo();
    open2.endLoc = geo.ok ? geo.data : { error: geo.error, ts: nowISO() };
    open2.endAt = nowISO();

    s.audit.unshift({ at: nowISO(), by: me.phone, action:"shift_end", data:{id:open2.id, geo_ok: geo.ok} });
    saveState(s);

    toast(geo.ok ? "Mesai bitti. Konum kaydedildi." : "Mesai bitti. Konum alƒ±namadƒ± (izin/red).");
    render();
  };
}

function escapeHtml(str){
  return (str||"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

ensurePWAStatus();
render();
</script>
</body>
</html>
