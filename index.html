<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#2563eb" />
  <title>UZMAN Puantaj</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icon-192.png" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    :root{
      --bg:#0b1220; --bg2:#0e1729; --card:#101a2f; --card2:#0f1a33;
      --muted:#93a4c7; --text:#e8efff; --brand:#2563eb; --brand2:#3b82f6;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --line:rgba(255,255,255,.08);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --r: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font: 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 800px at 10% -10%, rgba(37,99,235,.25), transparent 60%),
                  radial-gradient(800px 600px at 100% 0%, rgba(34,197,94,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .app{min-height:100vh;display:grid;grid-template-columns:280px 1fr}
    .sidebar{
      position:sticky; top:0; height:100vh; padding:18px 14px;
      background: linear-gradient(180deg, rgba(16,26,47,.92), rgba(9,13,24,.92));
      border-right: 1px solid var(--line); backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px; padding:10px 10px 16px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(37,99,235,1), rgba(59,130,246,.8));
      box-shadow: 0 12px 30px rgba(37,99,235,.35);
      display:grid; place-items:center; font-weight:900;
    }
    .brand h1{font-size:16px;margin:0}
    .brand small{display:block;color:var(--muted); margin-top:2px}
    .nav{display:flex; flex-direction:column; gap:6px; padding:10px 6px}
    .nav button{
      all:unset; display:flex; align-items:center; gap:10px;
      padding:10px 10px; border-radius:14px; color:rgba(232,239,255,.9);
      cursor:pointer; transition:.15s ease; border:1px solid transparent;
    }
    .nav button:hover{background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.06)}
    .nav button.active{background: rgba(37,99,235,.18); border-color: rgba(37,99,235,.35)}
    .nav .dot{width:10px;height:10px;border-radius:50%;background: rgba(255,255,255,.18)}
    .nav button.active .dot{background: var(--brand2)}
    .side-footer{
      position:absolute; left:14px; right:14px; bottom:14px;
      padding:10px 10px; border:1px solid var(--line);
      border-radius: 16px; background: rgba(255,255,255,.03);
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background: rgba(255,255,255,.03);
      color: var(--muted); font-size:12px;
    }
    .content{padding:18px 18px 26px}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px 14px; background: rgba(255,255,255,.03);
      border:1px solid var(--line); border-radius: var(--r);
      box-shadow: var(--shadow); backdrop-filter: blur(10px);
    }
    .topbar .title{display:flex; flex-direction:column; gap:2px}
    .topbar .title strong{font-size:16px}
    .topbar .title span{color:var(--muted); font-size:12px}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      border:1px solid var(--line); background: rgba(255,255,255,.04);
      color: var(--text); padding:10px 12px; border-radius: 14px;
      cursor:pointer; transition:.15s ease; display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.06)}
    .btn.primary{background: rgba(37,99,235,.22); border-color: rgba(37,99,235,.45)}
    .btn.primary:hover{background: rgba(37,99,235,.28)}
    .btn.ok{background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.35)}
    .btn.bad{background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.35)}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .grid{display:grid; gap:14px; grid-template-columns: 1.1fr .9fr; margin-top:14px}
    .card{
      background: linear-gradient(180deg, rgba(16,26,47,.85), rgba(10,14,26,.85));
      border:1px solid var(--line); border-radius: var(--r);
      box-shadow: var(--shadow); overflow:hidden;
    }
    .card .hd{
      padding:12px 14px; border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center;
      background: rgba(255,255,255,.03);
    }
    .card .hd strong{font-size:13px}
    .card .bd{padding:14px}
    .kpis{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
    .kpi{padding:12px 12px; border:1px solid var(--line); border-radius: 16px; background: rgba(255,255,255,.03)}
    .kpi .v{font-size:18px; font-weight:800}
    .kpi .l{font-size:12px; color:var(--muted)}
    .table{width:100%; border-collapse: collapse; overflow:auto}
    .table th, .table td{
      text-align:left; padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align: top; white-space: nowrap;
    }
    .table th{
      font-size:12px; color: var(--muted); font-weight:700;
      position:sticky; top:0; background: rgba(16,26,47,.9); z-index:1;
    }
    .tag{
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px;
      border-radius:999px; border:1px solid var(--line);
      background: rgba(255,255,255,.03); font-size:12px; color: var(--muted);
    }
    .tag.ok{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); color: rgba(180,255,210,.9)}
    .tag.bad{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); color: rgba(255,200,200,.95)}
    .tag.warn{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); color: rgba(255,230,180,.95)}
    .form{display:grid; gap:10px}
    label{font-size:12px; color: var(--muted)}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius: 14px;
      border:1px solid var(--line); background: rgba(255,255,255,.03);
      color: var(--text); outline:none;
    }
    textarea{min-height:96px; resize:vertical}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .hint{color:var(--muted); font-size:12px}
    .sep{height:1px; background: var(--line); margin:12px 0}
    .notice{
      padding:10px 12px; border-radius: 14px;
      border:1px solid rgba(37,99,235,.35);
      background: rgba(37,99,235,.10);
      color: rgba(232,239,255,.92); font-size:12px;
    }
    .error{
      padding:10px 12px; border-radius: 14px;
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
      color: rgba(255,220,220,.96); font-size:12px;
    }
    .maplink{color: rgba(180,210,255,.95); text-decoration: underline; cursor:pointer}
    .modal{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:50;
    }
    .modal.on{display:flex}
    .modal .panel{
      width:min(980px, 100%); max-height: 88vh; overflow:auto;
      border-radius: 20px; border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,26,47,.95), rgba(10,14,26,.95));
      box-shadow: 0 24px 90px rgba(0,0,0,.55);
    }
    .modal .panel .hd{position:sticky; top:0}
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:12px; white-space: pre; overflow:auto;
      padding:12px; border-radius: 14px; border:1px solid var(--line);
      background: rgba(0,0,0,.25)
    }
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative; height:auto}
      .grid{grid-template-columns: 1fr}
      .kpis{grid-template-columns: 1fr}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">U</div>
        <div>
          <h1>UZMAN Puantaj</h1>
          <small>CanlÄ± sÃ¼rÃ¼m (Supabase)</small>
        </div>
      </div>

      <div class="nav" id="nav">
        <button data-view="home" class="active"><span class="dot"></span> Ana Sayfa</button>
        <button data-view="personel"><span class="dot"></span> Personel</button>
        <button data-view="admin"><span class="dot"></span> Admin Paneli</button>
        <button data-view="ayar"><span class="dot"></span> Kurulum & Ayarlar</button>
      </div>

      <div class="side-footer">
        <div class="pill" id="pillStatus">â— BaÄŸlantÄ±: <b id="connText">KapalÄ±</b></div>
        <div class="hint" style="margin-top:8px">
          Konum izni yoksa â€œBaÅŸlandÄ± / Bittiâ€ Ã§alÄ±ÅŸmaz.
        </div>
      </div>
    </aside>

    <main class="content">
      <div class="topbar">
        <div class="title">
          <strong id="topTitle">Ana Sayfa</strong>
          <span id="topSub">Puantaj kayÄ±tlarÄ± + konum doÄŸrulama</span>
        </div>
        <div class="actions">
          <button class="btn" id="btnInstall" style="display:none">â• Ana ekrana ekle</button>
          <button class="btn" id="btnLogout">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
      </div>

      <div id="viewHome" class="grid">
        <div class="card">
          <div class="hd"><strong>GiriÅŸ</strong><span class="tag" id="whoTag">â€”</span></div>
          <div class="bd">
            <div class="notice" id="setupNotice" style="display:none">
              Ä°lk kurulum gerekli: Supabase URL + Public Key giriniz.
            </div>

            <div class="two">
              <div>
                <label>Mod</label>
                <select id="modeSel">
                  <option value="personel">Personel</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <div>
                <label>Telefon</label>
                <input id="phone" placeholder="+90..." inputmode="tel" />
              </div>
            </div>
            <div class="two">
              <div>
                <label>PIN</label>
                <input id="pin" placeholder="****" inputmode="numeric" type="password" />
                <div class="hint">Personel iÃ§in varsayÄ±lan: telefonun son 4 hanesi.</div>
              </div>
              <div style="display:flex; align-items:end; gap:10px">
                <button class="btn primary" id="btnLogin" style="width:100%">GiriÅŸ Yap</button>
              </div>
            </div>

            <div class="sep"></div>

            <div class="kpis">
              <div class="kpi">
                <div class="v" id="kpiUsers">â€”</div>
                <div class="l">KayÄ±tlÄ± kullanÄ±cÄ±</div>
              </div>
              <div class="kpi">
                <div class="v" id="kpiTerm">â€”</div>
                <div class="l">Terminal</div>
              </div>
              <div class="kpi">
                <div class="v" id="kpiShift">â€”</div>
                <div class="l">BugÃ¼n kayÄ±t</div>
              </div>
            </div>

            <div class="sep"></div>
            <div id="homeErr" class="error" style="display:none"></div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><strong>Durum</strong><span class="tag" id="geoTag">Konum: â€”</span></div>
          <div class="bd">
            <div class="form">
              <div>
                <label>Konum Sonucu</label>
                <div class="hint" id="geoText">HenÃ¼z istenmedi.</div>
              </div>
              <button class="btn ok" id="btnTestGeo">ğŸ“ Konumu test et</button>
              <div class="hint">GitHub Pages Ã¼zerinden HTTPS olduÄŸu iÃ§in konum Ã§alÄ±ÅŸÄ±r. (VPN / tarayÄ±cÄ± izinleri Ã¶nemli)</div>
            </div>
          </div>
        </div>
      </div>

      <div id="viewPersonel" class="grid" style="display:none">
        <div class="card">
          <div class="hd"><strong>Personel Paneli</strong><span class="tag" id="pUser">â€”</span></div>
          <div class="bd">
            <div class="two">
              <div>
                <label>Terminal</label>
                <select id="pTerminal"></select>
                <div class="hint">BaÅŸlama/BitiÅŸ konumu kaydÄ± terminale baÄŸlanÄ±r.</div>
              </div>
              <div>
                <label>BugÃ¼n</label>
                <input id="pToday" disabled />
              </div>
            </div>
            <div class="sep"></div>
            <div class="two">
              <button class="btn ok" id="btnStart">âœ… BaÅŸlandÄ±</button>
              <button class="btn bad" id="btnEnd">â›” Bitti</button>
            </div>
            <div class="hint" style="margin-top:8px" id="pHint"></div>
            <div class="sep"></div>

            <div class="card" style="border-radius:16px">
              <div class="hd"><strong>Geriye dÃ¶nÃ¼k mesai Ã§izelgesi</strong><span class="tag" id="pSum">â€”</span></div>
              <div class="bd" style="padding:0">
                <div style="max-height:380px; overflow:auto">
                  <table class="table" id="pTable">
                    <thead>
                      <tr>
                        <th>Tarih</th>
                        <th>BaÅŸlandÄ±</th>
                        <th>Bitti</th>
                        <th>SÃ¼re</th>
                        <th>Mola</th>
                        <th>Net</th>
                        <th>Terminal</th>
                        <th>Konum</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="sep"></div>
            <div id="pErr" class="error" style="display:none"></div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><strong>Konum KayÄ±t</strong><span class="tag" id="pGeo">â€”</span></div>
          <div class="bd">
            <div class="hint">Konum izni verilmezse mesai baÅŸlatÄ±lamaz / bitirilemez.</div>
            <div class="sep"></div>
            <div class="form">
              <div>
                <label>Son Ã¶lÃ§Ã¼m</label>
                <div class="hint" id="pGeoText">â€”</div>
              </div>
              <button class="btn" id="btnRefreshP">â†» Yenile</button>
            </div>
          </div>
        </div>
      </div>

      <div id="viewAdmin" class="grid" style="display:none">
        <div class="card">
          <div class="hd"><strong>Admin Paneli</strong><span class="tag" id="aUser">â€”</span></div>
          <div class="bd">
            <div class="two">
              <div>
                <label>Personel seÃ§</label>
                <select id="aPerson"></select>
              </div>
              <div>
                <label>Terminal seÃ§</label>
                <select id="aTermSel"></select>
              </div>
            </div>

            <div class="two" style="margin-top:10px">
              <div>
                <label>BaÅŸlangÄ±Ã§ tarihi</label>
                <input type="date" id="aFrom" />
              </div>
              <div>
                <label>BitiÅŸ tarihi</label>
                <input type="date" id="aTo" />
              </div>
            </div>

            <div class="two" style="margin-top:10px">
              <button class="btn primary" id="btnLoadRange">ğŸ“Š AralÄ±ÄŸÄ± Getir</button>
              <button class="btn" id="btnExportCsv">â¬‡ CSV indir</button>
            </div>

            <div class="sep"></div>

            <div class="kpis">
              <div class="kpi">
                <div class="v" id="aTotal">â€”</div>
                <div class="l">Toplam (Net)</div>
              </div>
              <div class="kpi">
                <div class="v" id="aLunch">â€”</div>
                <div class="l">Toplam mola dÃ¼ÅŸÃ¼mÃ¼</div>
              </div>
              <div class="kpi">
                <div class="v" id="aCount">â€”</div>
                <div class="l">KayÄ±t adedi</div>
              </div>
            </div>

            <div class="sep"></div>

            <div style="max-height:420px; overflow:auto; border-radius:16px">
              <table class="table" id="aTable">
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Personel</th>
                    <th>Terminal</th>
                    <th>BaÅŸlandÄ±</th>
                    <th>Bitti</th>
                    <th>SÃ¼re</th>
                    <th>Mola</th>
                    <th>Net</th>
                    <th>BaÅŸlandÄ± Konum</th>
                    <th>Bitti Konum</th>
                    <th>DÃ¼zenle</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="sep"></div>
            <div id="aErr" class="error" style="display:none"></div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><strong>YÃ¶netim</strong><span class="tag">Yetkiler</span></div>
          <div class="bd">
            <div class="notice">
              Manuel mesai dÃ¼zeltme ve kullanÄ±cÄ±/terminal yÃ¶netimi sadece admin iÃ§indir.
            </div>
            <div class="sep"></div>

            <div class="card" style="border-radius:16px">
              <div class="hd"><strong>Personel Ekle</strong><span class="tag">PIN = son 4</span></div>
              <div class="bd">
                <div class="two">
                  <div>
                    <label>Telefon</label>
                    <input id="newPhone" placeholder="+905..." inputmode="tel" />
                  </div>
                  <div>
                    <label>Ad Soyad</label>
                    <input id="newName" placeholder="Ã–rn: Mehmet Kara" />
                  </div>
                </div>
                <div class="two" style="margin-top:10px">
                  <div>
                    <label>Rol</label>
                    <select id="newRole">
                      <option value="personel">Personel</option>
                      <option value="admin">Admin</option>
                    </select>
                  </div>
                  <div style="display:flex; align-items:end">
                    <button class="btn primary" id="btnAddUser" style="width:100%">â• Ekle</button>
                  </div>
                </div>
                <div class="hint" style="margin-top:8px">
                  Admin eklenebilir/silinebilir. â€œSahipâ€ adminler silinemez (taÃ§).
                </div>
                <div id="userMgmtErr" class="error" style="display:none; margin-top:10px"></div>
              </div>
            </div>

            <div class="sep"></div>

            <div class="card" style="border-radius:16px">
              <div class="hd"><strong>Terminal Ekle</strong><span class="tag">admin</span></div>
              <div class="bd">
                <div class="two">
                  <div>
                    <label>Terminal AdÄ±</label>
                    <input id="newTermName" placeholder="Ã–rn: 1001 Derince Terminali" />
                  </div>
                  <div style="display:flex; align-items:end">
                    <button class="btn primary" id="btnAddTerm" style="width:100%">â• Terminal Ekle</button>
                  </div>
                </div>
                <div id="termMgmtErr" class="error" style="display:none; margin-top:10px"></div>
              </div>
            </div>

            <div class="sep"></div>
            <button class="btn bad" id="btnDangerReset">âš  Kurulumu SÄ±fÄ±rla (Sadece cihaz)</button>
          </div>
        </div>
      </div>

      <div id="viewAyar" class="grid" style="display:none">
        <div class="card">
          <div class="hd"><strong>Kurulum & Ayarlar</strong><span class="tag">Supabase</span></div>
          <div class="bd">
            <div class="notice">
              Bu ekran sadece anahtarlarÄ± girip test etmek iÃ§in. Anahtarlar cihazda saklanÄ±r.
            </div>
            <div class="sep"></div>

            <div class="two">
              <div>
                <label>Supabase Project URL</label>
                <input id="cfgUrl" placeholder="https://xxxx.supabase.co" />
              </div>
              <div>
                <label>Supabase Public Key</label>
                <input id="cfgKey" placeholder="sb-publishable-..." type="password" />
              </div>
            </div>

            <div class="two" style="margin-top:10px">
              <button class="btn primary" id="btnSaveCfg">ğŸ’¾ Kaydet</button>
              <button class="btn" id="btnTestCfg">ğŸ”Œ BaÄŸlantÄ±yÄ± Test Et</button>
            </div>

            <div class="sep"></div>

            <div class="card" style="border-radius:16px">
              <div class="hd"><strong>Supabase SQL (Tablolar)</strong><span class="tag">1 defa</span></div>
              <div class="bd">
                <div class="hint">Supabase â†’ SQL Editor iÃ§ine yapÄ±ÅŸtÄ±rÄ±p Ã§alÄ±ÅŸtÄ±r.</div>
                <div class="mono" id="sqlBox"></div>
                <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
                  <button class="btn" id="btnCopySql">ğŸ“‹ SQL Kopyala</button>
                  <button class="btn" id="btnSeedOwners">ğŸ‘‘ Sahip adminleri oluÅŸtur</button>
                </div>
                <div class="hint" style="margin-top:8px">
                  Sahip adminler: senin 2 numaran (taÃ§ iÅŸareti). Bu adÄ±m PINâ€™i ekranda gÃ¶stermez.
                </div>
                <div id="sqlErr" class="error" style="display:none; margin-top:10px"></div>
              </div>
            </div>

            <div class="sep"></div>
            <div class="hint" id="cfgHint">â€”</div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><strong>PWA</strong><span class="tag">Kurulum</span></div>
          <div class="bd">
            <div class="hint">
              Android (Chrome): MenÃ¼ â†’ â€œAna ekrana ekleâ€.<br>
              iOS (Safari): PaylaÅŸ â†’ â€œAna Ekrana Ekleâ€.<br><br>
              Konum iÃ§in HTTPS ÅŸart. GitHub Pages uygundur.
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="modal" id="editModal">
    <div class="panel card">
      <div class="hd">
        <strong>Mesai DÃ¼zenle</strong>
        <div style="display:flex; gap:10px">
          <button class="btn" id="btnCloseEdit">Kapat</button>
          <button class="btn primary" id="btnSaveEdit">Kaydet</button>
        </div>
      </div>
      <div class="bd">
        <div class="two">
          <div>
            <label>BaÅŸlangÄ±Ã§ (ISO / yerel)</label>
            <input id="eStart" placeholder="2026-02-08T08:00" />
          </div>
          <div>
            <label>BitiÅŸ (ISO / yerel)</label>
            <input id="eEnd" placeholder="2026-02-08T18:00" />
          </div>
        </div>
        <div class="two" style="margin-top:10px">
          <div>
            <label>Terminal</label>
            <select id="eTerminal"></select>
          </div>
          <div>
            <label>AÃ§Ä±klama</label>
            <input id="eNote" placeholder="Manuel dÃ¼zeltme notu..." />
          </div>
        </div>
        <div class="hint" style="margin-top:10px">Not: 9 saati geÃ§en Ã§alÄ±ÅŸmada 1 saat mola otomatik dÃ¼ÅŸÃ¼lÃ¼r (raporda gÃ¶sterilir).</div>
        <div id="eErr" class="error" style="display:none; margin-top:10px"></div>
      </div>
    </div>
  </div>

  <script src="./app.js"></script>
</body>
</html>
